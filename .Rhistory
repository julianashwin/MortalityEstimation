pop_matrix[which(is.na(pop_matrix[,ii])),ii] <- pop_matrix[which(is.na(pop_matrix[,ii])),(ii-1)]
}
temp_df <- create_LC_df(mx_matrix, pop_matrix, "none", cc, nahead = 6)
View(mx_matrix)
View(pop_matrix)
min(mort_df$mx_f[which(mort_df$mx_f>0)])
mort_df$mx_f[which(mort_df$mx_f==0)] <- min(mort_df$mx_f[which(mort_df$mx_f>0)])
print(paste0("Lee-Carter forecasts for ", cc))
country_df <- mort_df[which(mort_df$name == cc & mort_df$year >= 1900),]
#bp_df <- mort_df[which(mort_df$name == "New Zealand"),]
country_LC_df <- LC_df[0,]
for (yy in est_years){
mx_matrix <- cast(country_df[which(country_df$year <= yy),c("year", "age", "mx_f")],
age ~ year, value = "mx_f")
pop_matrix <- cast(country_df[which(country_df$year <= yy),c("year", "age", "Female")],
age ~ year, value = "Female")
if (ncol(mx_matrix) > 10){
# Carry over pop data if missing
for (ii in 2:ncol(pop_matrix)){
pop_matrix[which(is.na(pop_matrix[,ii])),ii] <- pop_matrix[which(is.na(pop_matrix[,ii])),(ii-1)]
}
# Possible adjustments: "dt", "dxt", "e0", "none"
# No adjustment
temp_df <- create_LC_df(mx_matrix, pop_matrix, "none", cc, nahead = 6)
# Lee-Carter adjustment
temp_df_dt <- create_LC_df(mx_matrix, pop_matrix, "dt", cc, nahead = 6)
names(temp_df_dt)[3:5] <- paste0(names(temp_df_dt)[3:5], "_dt")
# BMS adjustment
temp_df_dxt <- create_LC_df(mx_matrix, pop_matrix, "dxt", cc, nahead = 6)
names(temp_df_dxt)[3:5] <- paste0(names(temp_df_dxt)[3:5], "_dxt")
# Life expectancy adjustment
temp_df_e0 <- create_LC_df(mx_matrix, pop_matrix, "e0", cc, nahead = 6)
names(temp_df_e0)[3:5] <- paste0(names(temp_df_e0)[3:5], "_e0")
# Combine
temp_df <- cbind(temp_df, temp_df_dt[,3:5], temp_df_dxt[,3:5], temp_df_e0[,3:5])
temp_df$est_year <- yy
temp_df$name <- cc
country_LC_df <- rbind(country_LC_df, temp_df[names(country_LC_df)])
}
}
yy
mx_matrix <- cast(country_df[which(country_df$year <= yy),c("year", "age", "mx_f")],
age ~ year, value = "mx_f")
pop_matrix <- cast(country_df[which(country_df$year <= yy),c("year", "age", "Female")],
age ~ year, value = "Female")
View(mx_matrix)
View(pop_matrix)
for (ii in 2:ncol(pop_matrix)){
pop_matrix[which(is.na(pop_matrix[,ii])),ii] <- pop_matrix[which(is.na(pop_matrix[,ii])),(ii-1)]
pop_matrix[which(pop_matrix==0),ii] <- 0.01
}
mx_matrix <- cast(country_df[which(country_df$year <= yy),c("year", "age", "mx_f")],
age ~ year, value = "mx_f")
pop_matrix <- cast(country_df[which(country_df$year <= yy),c("year", "age", "Female")],
age ~ year, value = "Female")
pop_matrix[which(is.na(pop_matrix[,ii])),ii] <- pop_matrix[which(is.na(pop_matrix[,ii])),(ii-1)]
pop_matrix[which(pop_matrix[,ii]==0),ii] <- 0.01
for (yy in est_years){
mx_matrix <- cast(country_df[which(country_df$year <= yy),c("year", "age", "mx_f")],
age ~ year, value = "mx_f")
pop_matrix <- cast(country_df[which(country_df$year <= yy),c("year", "age", "Female")],
age ~ year, value = "Female")
if (ncol(mx_matrix) > 10){
# Carry over pop data if missing
for (ii in 2:ncol(pop_matrix)){
pop_matrix[which(is.na(pop_matrix[,ii])),ii] <- pop_matrix[which(is.na(pop_matrix[,ii])),(ii-1)]
pop_matrix[which(pop_matrix[,ii]==0),ii] <- 0.01
}
# Possible adjustments: "dt", "dxt", "e0", "none"
# No adjustment
temp_df <- create_LC_df(mx_matrix, pop_matrix, "none", cc, nahead = 6)
# Lee-Carter adjustment
temp_df_dt <- create_LC_df(mx_matrix, pop_matrix, "dt", cc, nahead = 6)
names(temp_df_dt)[3:5] <- paste0(names(temp_df_dt)[3:5], "_dt")
# BMS adjustment
temp_df_dxt <- create_LC_df(mx_matrix, pop_matrix, "dxt", cc, nahead = 6)
names(temp_df_dxt)[3:5] <- paste0(names(temp_df_dxt)[3:5], "_dxt")
# Life expectancy adjustment
temp_df_e0 <- create_LC_df(mx_matrix, pop_matrix, "e0", cc, nahead = 6)
names(temp_df_e0)[3:5] <- paste0(names(temp_df_e0)[3:5], "_e0")
# Combine
temp_df <- cbind(temp_df, temp_df_dt[,3:5], temp_df_dxt[,3:5], temp_df_e0[,3:5])
temp_df$est_year <- yy
temp_df$name <- cc
country_LC_df <- rbind(country_LC_df, temp_df[names(country_LC_df)])
}
}
View(country_LC_df)
"
International Lee-Carter
"
# Identify countries
countries <- unique(mort_df$name)
countries <- countries[which(countries %in% names(col_scheme))]
LC_df <- data.frame(matrix(NA, nrow = 0, ncol = 16))
names(LC_df) <-c("name","year", "est_year", "age", "mx_LC", "lx_LC", "ex_LC",
"mx_LC_dt", "lx_LC_dt", "ex_LC_dt","mx_LC_dxt", "lx_LC_dxt", "ex_LC_dxt",
"mx_LC_e0", "lx_LC_e0", "ex_LC_e0")
cc <- countries[9]
yy <- est_years[6]
for (cc in countries){
print(paste0("Lee-Carter forecasts for ", cc))
country_df <- mort_df[which(mort_df$name == cc & mort_df$year >= 1900),]
#bp_df <- mort_df[which(mort_df$name == "New Zealand"),]
country_LC_df <- LC_df[0,]
for (yy in est_years){
mx_matrix <- cast(country_df[which(country_df$year <= yy),c("year", "age", "mx_f")],
age ~ year, value = "mx_f")
pop_matrix <- cast(country_df[which(country_df$year <= yy),c("year", "age", "Female")],
age ~ year, value = "Female")
if (ncol(mx_matrix) > 10){
# Carry over pop data if missing
for (ii in 2:ncol(pop_matrix)){
pop_matrix[which(is.na(pop_matrix[,ii])),ii] <- pop_matrix[which(is.na(pop_matrix[,ii])),(ii-1)]
pop_matrix[which(pop_matrix[,ii]==0),ii] <- 0.01
}
# Possible adjustments: "dt", "dxt", "e0", "none"
# No adjustment
temp_df <- create_LC_df(mx_matrix, pop_matrix, "none", cc, nahead = 6)
# Lee-Carter adjustment
temp_df_dt <- create_LC_df(mx_matrix, pop_matrix, "dt", cc, nahead = 6)
names(temp_df_dt)[3:5] <- paste0(names(temp_df_dt)[3:5], "_dt")
# BMS adjustment
temp_df_dxt <- create_LC_df(mx_matrix, pop_matrix, "dxt", cc, nahead = 6)
names(temp_df_dxt)[3:5] <- paste0(names(temp_df_dxt)[3:5], "_dxt")
# Life expectancy adjustment
temp_df_e0 <- create_LC_df(mx_matrix, pop_matrix, "e0", cc, nahead = 6)
names(temp_df_e0)[3:5] <- paste0(names(temp_df_e0)[3:5], "_e0")
# Combine
temp_df <- cbind(temp_df, temp_df_dt[,3:5], temp_df_dxt[,3:5], temp_df_e0[,3:5])
temp_df$est_year <- yy
temp_df$name <- cc
country_LC_df <- rbind(country_LC_df, temp_df[names(country_LC_df)])
}
}
LC_df <- rbind(LC_df, country_LC_df[names(LC_df)])
}
rm(country_df, mx_matrix, pop_matrix, temp_df, temp_df_dt, temp_df_dxt, temp_df_e0,yy,cc)
country_forecasts_df <- merge(mort_df, LC_df,by = c("name", "year", "age"), all.y = T)
ggplot(country_forecasts_df[which(country_forecasts_df$age == 0),]) + theme_bw() +
geom_point(aes(x = year, y = ex_f), shape = 3)
ggplot(country_forecasts_df[which(country_forecasts_df$age == 0),]) + theme_bw() +
facet_wrap(name~., nrow = 4, scales = "free") +
geom_point(aes(x = year, y = ex_f), shape = 3) +
scale_color_manual("Model", values = c("Siler" = "purple", "Lee-Carter" = "red",
"Lee-Carter (dt)" = "gold", "Lee-Carter (dxt)" = "green", "Lee-Carter (e0)" = "blue")) +
geom_line(aes(x = year, y = ex_LC, group = est_year, color = "Lee-Carter"), alpha =0.3) +
geom_line(aes(x = year, y = ex_LC_dt, group = est_year, color= "Lee-Carter (dt)"), alpha =0.3) +
geom_line(aes(x = year, y = ex_LC_dxt, group = est_year, color = "Lee-Carter (dxt)"), alpha =0.3) +
geom_line(aes(x = year, y = ex_LC_e0, group = est_year, color = "Lee-Carter (e0)"), alpha =0.3) +
#geom_line(aes(x = year, y = ex_siler, group = est_year, color = "Siler")) +
xlab("Year") + ylab("Life expectancy at birth")
forecasts_df$n_ahead <- forecasts_df$year - forecasts_df$est_year
forecasts_df$n_ahead[which(forecasts_df$n_ahead <= 0)] <- NA
compute_fe <- function(forecasts_df, suffix = "siler"){
oos_obs <- which(forecasts_df$year > forecasts_df$est_year)
is_obs <- which(forecasts_df$year <= forecasts_df$est_year)
# Forecast error
forecasts_df[,paste0(suffix,"_fe")] <- NA
forecasts_df[oos_obs,paste0(suffix,"_fe")] <- forecasts_df$ex_f[oos_obs] -
forecasts_df[oos_obs,paste0("ex_",suffix)]
forecasts_df[,paste0(suffix,"_fe2")] <- forecasts_df[,paste0(suffix,"_fe")]^2
# In-sample error
forecasts_df[,paste0(suffix,"_err")] <- NA
forecasts_df[is_obs,paste0(suffix,"_err")] <- forecasts_df$ex_f[is_obs] -
forecasts_df[is_obs,paste0("ex_",suffix)]
forecasts_df[,paste0(suffix,"_err2")] <- forecasts_df[,paste0(suffix,"_err")]^2
return(forecasts_df)
}
forecasts_df <- compute_fe(forecasts_df, suffix = "LC")
forecasts_df <- compute_fe(forecasts_df, suffix = "LC_dt")
forecasts_df <- compute_fe(forecasts_df, suffix = "LC_dxt")
forecasts_df <- compute_fe(forecasts_df, suffix = "LC_e0")
country_forecasts_df$n_ahead <- country_forecasts_df$year - country_forecasts_df$est_year
country_forecasts_df$n_ahead[which(country_forecasts_df$n_ahead <= 0)] <- NA
country_forecasts_df <- compute_fe(country_forecasts_df, suffix = "LC")
country_forecasts_df <- compute_fe(country_forecasts_df, suffix = "LC_dt")
country_forecasts_df <- compute_fe(country_forecasts_df, suffix = "LC_dxt")
country_forecasts_df <- compute_fe(country_forecasts_df, suffix = "LC_e0")
country_forecasts_df$n_ahead <- country_forecasts_df$year - country_forecasts_df$est_year
country_forecasts_df$n_ahead[which(country_forecasts_df$n_ahead <= 0)] <- NA
country_forecasts_df <- compute_fe(country_forecasts_df, suffix = "LC")
country_forecasts_df <- compute_fe(country_forecasts_df, suffix = "LC_dt")
country_forecasts_df <- compute_fe(country_forecasts_df, suffix = "LC_dxt")
country_forecasts_df <- compute_fe(country_forecasts_df, suffix = "LC_e0")
fe_plt <- ggplot(country_forecasts_df[which(forecasts_df$age == 0),]) + theme_bw() +
scale_fill_manual("Model", values = c("Siler" = "purple", "Lee-Carter" = "red",
"Lee-Carter (dt)" = "gold", "Lee-Carter (dxt)" = "green", "Lee-Carter (e0)" = "blue")) +
#geom_bar(aes(x = n_ahead-1, y = siler_fe2, fill = "Siler"),
#         stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead-0.5, y = LC_fe2, fill = "Lee-Carter"),
stat = "summary", fun = mean, width = 0.5)
fe_plt
fe_plt <- ggplot(country_forecasts_df[which(forecasts_df$age == 0),]) + theme_bw() +
scale_fill_manual("Model", values = c("Siler" = "purple", "Lee-Carter" = "red",
"Lee-Carter (dt)" = "gold", "Lee-Carter (dxt)" = "green", "Lee-Carter (e0)" = "blue")) +
#geom_bar(aes(x = n_ahead-1, y = siler_fe2, fill = "Siler"),
#         stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead-0.5, y = LC_fe2, fill = "Lee-Carter"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead, y = LC_dt_fe2, fill = "Lee-Carter (dt)"),
stat = "summary", fun = mean, width = 0.5)
fe_plt
fe_plt <- ggplot(country_forecasts_df[which(forecasts_df$age == 0),]) + theme_bw() +
scale_fill_manual("Model", values = c("Siler" = "purple", "Lee-Carter" = "red",
"Lee-Carter (dt)" = "gold", "Lee-Carter (dxt)" = "green", "Lee-Carter (e0)" = "blue")) +
#geom_bar(aes(x = n_ahead-1, y = siler_fe2, fill = "Siler"),
#         stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead-0.5, y = LC_fe2, fill = "Lee-Carter"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead, y = LC_dt_fe2, fill = "Lee-Carter (dt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead+0.5, y = LC_dxt_fe2, fill = "Lee-Carter (dxt)"),
stat = "summary", fun = mean, width = 0.5)
fe_plt
ggplot(country_forecasts_df[which(forecasts_df$age == 0),]) + theme_bw() +
scale_fill_manual("Model", values = c("Siler" = "purple", "Lee-Carter" = "red",
"Lee-Carter (dt)" = "gold", "Lee-Carter (dxt)" = "green", "Lee-Carter (e0)" = "blue")) +
#geom_bar(aes(x = n_ahead-1, y = siler_fe2, fill = "Siler"),
#         stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead-0.5, y = LC_fe2, fill = "Lee-Carter"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead, y = LC_dt_fe2, fill = "Lee-Carter (dt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead+0.5, y = LC_dxt_fe2, fill = "Lee-Carter (dxt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead+1, y = LC_e0_fe2, fill = "Lee-Carter (e0)"),
stat = "summary", fun = mean, width = 0.5) +
xlab("Years ahead") + ylab("MSE")+ ggtitle("Out-of-sample")
ggplot(forecasts_df[which(forecasts_df$age == 0),]) + theme_bw() +
scale_fill_manual("Model", values = c("Siler" = "purple", "Lee-Carter" = "red",
"Lee-Carter (dt)" = "gold", "Lee-Carter (dxt)" = "green", "Lee-Carter (e0)" = "blue")) +
#geom_bar(aes(x = est_year-1, y = siler_err2, fill = "Siler"),
#         stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = est_year-0.5, y = LC_err2, fill = "Lee-Carter"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = est_year, y = LC_dt_err2, fill = "Lee-Carter (dt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = est_year+0.5, y = LC_dxt_err2, fill = "Lee-Carter (dxt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = est_year+1, y = LC_e0_err2, fill = "Lee-Carter (e0)"),
stat = "summary", fun = mean, width = 0.5) +
xlab("Est. year") + ylab("MSE")+ ggtitle("In-sample")
t.test(forecasts_df$siler_fe[which(forecasts_df$age == 0)], na.rm = T)
fe_plt <- ggplot(country_forecasts_df[which(country_forecasts_df$age == 0),]) + theme_bw() +
scale_fill_manual("Model", values = c("Siler" = "purple", "Lee-Carter" = "red",
"Lee-Carter (dt)" = "gold", "Lee-Carter (dxt)" = "green", "Lee-Carter (e0)" = "blue")) +
#geom_bar(aes(x = n_ahead-1, y = siler_fe2, fill = "Siler"),
#         stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead-0.5, y = LC_fe2, fill = "Lee-Carter"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead, y = LC_dt_fe2, fill = "Lee-Carter (dt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead+0.5, y = LC_dxt_fe2, fill = "Lee-Carter (dxt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead+1, y = LC_e0_fe2, fill = "Lee-Carter (e0)"),
stat = "summary", fun = mean, width = 0.5) +
xlab("Years ahead") + ylab("MSE")+ ggtitle("Out-of-sample")
fe_plt
ggplot(country_forecasts_df[which(country_forecasts_df$age == 0),]) + theme_bw() +
scale_fill_manual("Model", values = c("Siler" = "purple", "Lee-Carter" = "red",
"Lee-Carter (dt)" = "gold", "Lee-Carter (dxt)" = "green", "Lee-Carter (e0)" = "blue")) +
#geom_bar(aes(x = est_year-1, y = siler_err2, fill = "Siler"),
#         stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = est_year-0.5, y = LC_err2, fill = "Lee-Carter"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = est_year, y = LC_dt_err2, fill = "Lee-Carter (dt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = est_year+0.5, y = LC_dxt_err2, fill = "Lee-Carter (dxt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = est_year+1, y = LC_e0_err2, fill = "Lee-Carter (e0)"),
stat = "summary", fun = mean, width = 0.5) +
xlab("Est. year") + ylab("MSE")+ ggtitle("In-sample")
ggplot(country_forecasts_df[which(country_forecasts_df$age == 0),]) + theme_bw() +
scale_fill_manual("Model", values = c("Siler" = "purple", "Lee-Carter" = "red",
"Lee-Carter (dt)" = "gold", "Lee-Carter (dxt)" = "green", "Lee-Carter (e0)" = "blue")) +
#geom_bar(aes(x = n_ahead-1, y = siler_fe2, fill = "Siler"),
#         stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead-0.5, y = LC_fe, fill = "Lee-Carter"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead, y = LC_dt_fe, fill = "Lee-Carter (dt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead+0.5, y = LC_dxt_fe, fill = "Lee-Carter (dxt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead+1, y = LC_e0_fe, fill = "Lee-Carter (e0)"),
stat = "summary", fun = mean, width = 0.5) +
xlab("Est. year") + ylab("Mean forecast error")+ ggtitle("FE")
t.test(forecasts_df$LC_e0_fe[which(forecasts_df$age == 0)], na.rm = T)
t.test(forecasts_df$LC_e0_fe[which(forecasts_df$age == 0)], na.rm = T)
mean(forecasts_df$LC_e0_fe[which(forecasts_df$age == 0)]^2, na.rm = T)
t.test(country_forecasts_df$LC_e0_fe[which(forecasts_df$age == 0)], na.rm = T)
mean(country_forecasts_df$LC_e0_fe[which(forecasts_df$age == 0)]^2, na.rm = T)
aggregate(country_forecasts_df[,c("LC_e0_fe", "LC_dxt_fe")],
by = list(name = country_forecasts_df$name))
aggregate(country_forecasts_df[,c("LC_e0_fe", "LC_dxt_fe")],
by = list(name = country_forecasts_df$name), FUN = mean)
aggregate(country_forecasts_df[which(!is.na(country_forecasts_df$LC_fe)),c("LC_e0_fe", "LC_dxt_fe")],
by = list(name = country_forecasts_df$name), FUN = mean,)
aggregate(country_forecasts_df[which(!is.na(country_forecasts_df$LC_fe)),c("LC_e0_fe", "LC_dxt_fe")],
by = list(name = country_forecasts_df$name[which(!is.na(country_forecasts_df$LC_fe))]), FUN = mean,)
aggregate(country_forecasts_df[which(!is.na(country_forecasts_df$LC_fe)),
c("LC_fe","LC_dt_fe", "LC_dxt_fe", "LC_e0_fe")],
by = list(name = country_forecasts_df$name[which(!is.na(country_forecasts_df$LC_fe))]), FUN = mean,)
fe_plt <- ggplot(country_forecasts_df[which(country_forecasts_df$age == 0),]) + theme_bw() +
scale_fill_manual("Model", values = c("Siler" = "purple", "Lee-Carter" = "red",
"Lee-Carter (dt)" = "gold", "Lee-Carter (dxt)" = "green", "Lee-Carter (e0)" = "blue")) +
#geom_bar(aes(x = n_ahead-1, y = siler_fe2, fill = "Siler"),
#         stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead-0.5, y = LC_fe2, fill = "Lee-Carter"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead, y = LC_dt_fe2, fill = "Lee-Carter (dt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead+0.5, y = LC_dxt_fe2, fill = "Lee-Carter (dxt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead+1, y = LC_e0_fe2, fill = "Lee-Carter (e0)"),
stat = "summary", fun = mean, width = 0.5) +
xlab("Years ahead") + ylab("MSE")+ ggtitle("MSE")
err_plt <- ggplot(country_forecasts_df[which(country_forecasts_df$age == 0),]) + theme_bw() +
scale_fill_manual("Model", values = c("Siler" = "purple", "Lee-Carter" = "red",
"Lee-Carter (dt)" = "gold", "Lee-Carter (dxt)" = "green", "Lee-Carter (e0)" = "blue")) +
#geom_bar(aes(x = n_ahead-1, y = siler_fe2, fill = "Siler"),
#         stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead-0.5, y = LC_fe, fill = "Lee-Carter"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead, y = LC_dt_fe, fill = "Lee-Carter (dt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead+0.5, y = LC_dxt_fe, fill = "Lee-Carter (dxt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead+1, y = LC_e0_fe, fill = "Lee-Carter (e0)"),
stat = "summary", fun = mean, width = 0.5) +
xlab("Est. year") + ylab("Mean forecast error")+ ggtitle("FE")
ggarrange(err_plt, fe_plt, nrow = 1, ncol = 2, common.legend = T, legend = "right")
ggplot(country_forecasts_df[which(country_forecasts_df$age == 0),]) + theme_bw() +
facet_wrap(name~., nrow = 4, scales = "free") +
geom_point(aes(x = year, y = ex_f), shape = 3) +
scale_color_manual("Model", values = c("Siler" = "purple", "Lee-Carter" = "red",
"Lee-Carter (dt)" = "gold", "Lee-Carter (dxt)" = "green", "Lee-Carter (e0)" = "blue")) +
geom_line(aes(x = year, y = ex_LC, group = est_year, color = "Lee-Carter"), alpha =0.3) +
geom_line(aes(x = year, y = ex_LC_dt, group = est_year, color= "Lee-Carter (dt)"), alpha =0.3) +
geom_line(aes(x = year, y = ex_LC_dxt, group = est_year, color = "Lee-Carter (dxt)"), alpha =0.3) +
geom_line(aes(x = year, y = ex_LC_e0, group = est_year, color = "Lee-Carter (e0)"), alpha =0.3) +
#geom_line(aes(x = year, y = ex_siler, group = est_year, color = "Siler")) +
xlab("Year") + ylab("Life expectancy at birth")
t.test(country_forecasts_df$LC_e0_fe[which(forecasts_df$age == 0)], na.rm = T)
t.test(country_forecasts_df$LC_e0_fe[which(forecasts_df$age == 0 &
forecasts_df$name == "Belgium")], na.rm = T)
country_forecasts_df$LC_e0_fe[which(forecasts_df$age == 0 &
forecasts_df$name == "Belgium")]
t.test(country_forecasts_df$LC_e0_fe[which(country_forecasts_df$age == 0)], na.rm = T)
mean(country_forecasts_df$LC_e0_fe[which(country_forecasts_df$age == 0)]^2, na.rm = T)
t.test(country_forecasts_df$LC_e0_err[which(country_forecasts_df$age == 0)], na.rm = T)
mean(country_forecasts_df$LC_e0_err[which(country_forecasts_df$age == 0)]^2, na.rm = T)
t.test(country_forecasts_df$LC_e0_fe[which(country_forecasts_df$age == 0 &
country_forecasts_df$name == "Belgium")], na.rm = T)
t.test(country_forecasts_df$LC_e0_fe[which(country_forecasts_df$age == 0 &
country_forecasts_df$name == "Canada")], na.rm = T)
t.test(country_forecasts_df$LC_e0_fe[which(country_forecasts_df$age == 0 &
country_forecasts_df$name == "Denmark")], na.rm = T)
t.test(country_forecasts_df$LC_e0_fe[which(country_forecasts_df$age == 0 &
country_forecasts_df$name == "Finland")], na.rm = T)
t.test(country_forecasts_df$LC_e0_fe[which(country_forecasts_df$age == 0 &
country_forecasts_df$name == "France")], na.rm = T)
t.test(country_forecasts_df$LC_e0_fe[which(country_forecasts_df$age == 0 &
country_forecasts_df$name == "Iceland")], na.rm = T)
t.test(country_forecasts_df$LC_e0_fe[which(country_forecasts_df$age == 0 &
country_forecasts_df$name == "Italy")], na.rm = T)
t.test(country_forecasts_df$LC_e0_fe[which(country_forecasts_df$age == 0 &
country_forecasts_df$name == "Japan")], na.rm = T)
t.test(country_forecasts_df$LC_e0_fe[which(country_forecasts_df$age == 0 &
country_forecasts_df$name == "Netherlands")], na.rm = T)
t.test(country_forecasts_df$LC_e0_fe[which(country_forecasts_df$age == 0 &
country_forecasts_df$name == "Norway")], na.rm = T)
t.test(country_forecasts_df$LC_e0_fe[which(country_forecasts_df$age == 0 &
country_forecasts_df$name == "Netherlands")], na.rm = T)
aggregate(country_forecasts_df[which(!is.na(country_forecasts_df$LC_fe)),
c("LC_fe","LC_dt_fe", "LC_dxt_fe", "LC_e0_fe")],
by = list(name = country_forecasts_df$name[which(!is.na(country_forecasts_df$LC_fe))]), FUN = mean,)
obs <- which(!is.na(country_forecasts_df$LC_fe & country_forecasts_df$age == 0))
aggregate(country_forecasts_df[obs,
c("LC_fe","LC_dt_fe", "LC_dxt_fe", "LC_e0_fe")],
by = list(name = country_forecasts_df$name[obs]), FUN = mean,)
obs <- which(!is.na(country_forecasts_df$LC_fe & country_forecasts_df$age == 0))
country_forecasts_dfobs
obs
obs <- which(!is.na(country_forecasts_df$LC_fe) & country_forecasts_df$age == 0))
obs <- which(!is.na(country_forecasts_df$LC_fe) & country_forecasts_df$age == 0)
aggregate(country_forecasts_df[obs,c("LC_fe","LC_dt_fe", "LC_dxt_fe", "LC_e0_fe")],
by = list(name = country_forecasts_df$name[obs]), FUN = mean,)
?lca
cc
countries <- unique(mort_df$name)
countries <- countries[which(countries %in% names(col_scheme))]
LC_df <- data.frame(matrix(NA, nrow = 0, ncol = 16))
names(LC_df) <-c("name","year", "est_year", "age", "mx_LC", "lx_LC", "ex_LC",
"mx_LC_dt", "lx_LC_dt", "ex_LC_dt","mx_LC_dxt", "lx_LC_dxt", "ex_LC_dxt",
"mx_LC_e0", "lx_LC_e0", "ex_LC_e0")
cc <- countries[9]
cc
cc <- countries[1]
cc
yy <- est_years[1]
print(paste0("Lee-Carter forecasts for ", cc))
country_df <- mort_df[which(mort_df$name == cc & mort_df$year >= 1900),]
#bp_df <- mort_df[which(mort_df$name == "New Zealand"),]
country_LC_df <- LC_df[0,]
mx_matrix <- cast(country_df[which(country_df$year <= yy),c("year", "age", "mx_f")],
age ~ year, value = "mx_f")
pop_matrix <- cast(country_df[which(country_df$year <= yy),c("year", "age", "Female")],
age ~ year, value = "Female")
(ncol(mx_matrix) > 10)
for (ii in 2:ncol(pop_matrix)){
pop_matrix[which(is.na(pop_matrix[,ii])),ii] <- pop_matrix[which(is.na(pop_matrix[,ii])),(ii-1)]
pop_matrix[which(pop_matrix[,ii]==0),ii] <- 0.01
}
temp_df <- create_LC_df(mx_matrix, pop_matrix, "none", cc, nahead = 6)
temp_df_dt <- create_LC_df(mx_matrix, pop_matrix, "dt", cc, nahead = 6)
names(temp_df_dt)[3:5] <- paste0(names(temp_df_dt)[3:5], "_dt")
temp_df_dxt <- create_LC_df(mx_matrix, pop_matrix, "dxt", cc, nahead = 6)
names(temp_df_dxt)[3:5] <- paste0(names(temp_df_dxt)[3:5], "_dxt")
temp_df_e0 <- create_LC_df(mx_matrix, pop_matrix, "e0", cc, nahead = 6)
names(temp_df_e0)[3:5] <- paste0(names(temp_df_e0)[3:5], "_e0")
temp_df <- cbind(temp_df, temp_df_dt[,3:5], temp_df_dxt[,3:5], temp_df_e0[,3:5])
temp_df$est_year <- yy
temp_df$name <- cc
country_LC_df <- rbind(country_LC_df, temp_df[names(country_LC_df)])
country_LC_df
LC_df <- rbind(LC_df, country_LC_df[names(LC_df)])
rm(country_df, mx_matrix, pop_matrix, temp_df, temp_df_dt, temp_df_dxt, temp_df_e0,yy,cc)
country_forecasts_df <- merge(mort_df, LC_df,by = c("name", "year", "age"), all.y = T)
ggplot(country_forecasts_df[which(country_forecasts_df$age == 0),]) + theme_bw() +
facet_wrap(name~., nrow = 4, scales = "free") +
geom_point(aes(x = year, y = ex_f), shape = 3) +
scale_color_manual("Model", values = c("Siler" = "purple", "Lee-Carter" = "red",
"Lee-Carter (dt)" = "gold", "Lee-Carter (dxt)" = "green", "Lee-Carter (e0)" = "blue")) +
geom_line(aes(x = year, y = ex_LC, group = est_year, color = "Lee-Carter"), alpha =0.3) +
geom_line(aes(x = year, y = ex_LC_dt, group = est_year, color= "Lee-Carter (dt)"), alpha =0.3) +
geom_line(aes(x = year, y = ex_LC_dxt, group = est_year, color = "Lee-Carter (dxt)"), alpha =0.3) +
geom_line(aes(x = year, y = ex_LC_e0, group = est_year, color = "Lee-Carter (e0)"), alpha =0.3) +
#geom_line(aes(x = year, y = ex_siler, group = est_year, color = "Siler")) +
xlab("Year") + ylab("Life expectancy at birth")
bp_demdata <- demogdata(data=mx_matrix[,2:ncol(mx_matrix)],
pop = pop_matrix[,2:ncol(mx_matrix)],
ages=mx_matrix$age,
years = as.numeric(names(mx_matrix[,2:ncol(mx_matrix)])),
type= "mortality",label=cc, name="female")
mx_matrix <- cast(country_df[which(country_df$year <= yy),c("year", "age", "mx_f")],
age ~ year, value = "mx_f")
pop_matrix <- cast(country_df[which(country_df$year <= yy),c("year", "age", "Female")],
age ~ year, value = "Female")
cc <- countries[1]
yy <- est_years[1]
print(paste0("Lee-Carter forecasts for ", cc))
country_df <- mort_df[which(mort_df$name == cc & mort_df$year >= 1900),]
#bp_df <- mort_df[which(mort_df$name == "New Zealand"),]
country_LC_df <- LC_df[0,]
mx_matrix <- cast(country_df[which(country_df$year <= yy),c("year", "age", "mx_f")],
age ~ year, value = "mx_f")
pop_matrix <- cast(country_df[which(country_df$year <= yy),c("year", "age", "Female")],
age ~ year, value = "Female")
for (ii in 2:ncol(pop_matrix)){
pop_matrix[which(is.na(pop_matrix[,ii])),ii] <- pop_matrix[which(is.na(pop_matrix[,ii])),(ii-1)]
pop_matrix[which(pop_matrix[,ii]==0),ii] <- 0.01
}
adj
adj <- "e0"
nahead = 6
bp_demdata <- demogdata(data=mx_matrix[,2:ncol(mx_matrix)],
pop = pop_matrix[,2:ncol(mx_matrix)],
ages=mx_matrix$age,
years = as.numeric(names(mx_matrix[,2:ncol(mx_matrix)])),
type= "mortality",label=cc, name="female")
bp_LC <- lca(bp_demdata, adjust = adj, chooseperiod = TRUE)
ncol(mx_matrix)
bp_LC <- lca(bp_demdata, adjust = adj, chooseperiod = TRUE,
minperiod = ncol(mx_matrix))
bp_LC <- lca(bp_demdata, adjust = adj, chooseperiod = TRUE,
minperiod = ncol(mx_matrix)-1)
bp_LC <- lca(bp_demdata, adjust = adj, chooseperiod = TRUE,
minperiod = ncol(mx_matrix)/2)
bp_LC <- lca(bp_demdata, adjust = adj, chooseperiod = TRUE,
minperiod = ncol(mx_matrix)+4)
bp_LC <- lca(bp_demdata, adjust = adj)
plot(bp_LC)
bp_LC <- lca(bp_demdata, adjust = adj,scale = TRUE)
plot(bp_LC)
bp_LC <- lca(bp_demdata, adjust = adj,scale = TRUE,
breakmethod = "bai")
plot(bp_LC)
bp_LC <- lca(bp_demdata, adjust = adj,scale = FALSE,
breakmethod = "bai")
plot(bp_LC)
bp_LC <- lca(bp_demdata, adjust = adj,scale = FALSE,
breakmethod = "bai", chooseperiod = TRUE)
install.packages("Epi")
bp_LC <- lca(bp_demdata, adjust = adj,scale = FALSE,
breakmethod = "bai", chooseperiod = TRUE)
bp_LC <- lca(bp_demdata, adjust = adj,scale = FALSE,
breakmethod = "bai", chooseperiod = TRUE, minperiod = 5)
bp_LC <- lca(bp_demdata, adjust = adj,scale = FALSE,
breakmethod = "bai", chooseperiod = TRUE, minperiod = 45)
bp_LC <- lca(bp_demdata, adjust = adj,scale = FALSE,
breakmethod = "bai", chooseperiod = TRUE, minperiod = 100)
bp_LC <- lca(bp_demdata, adjust = adj,scale = FALSE,
breakmethod = "bai", chooseperiod = TRUE, minperiod = 1)
bp_LC <- lca(bp_demdata, adjust = adj,scale = FALSE,
breakmethod = "bai", chooseperiod = TRUE, minperiod = 0)
mx_matrix
View(mx_matrix)
data(testisDK)
require(Epi)
install.packages("Epi")
require(Epi)
