stat = "summary", fun = mean, width = 0.5) +
xlab("Years ahead") + ylab("Mean forecast error")+ ggtitle("FE")
ggarrange(err_plt, fe_plt, nrow = 1, ncol = 2, common.legend = T, legend = "right")
# Plot the errors
fe_plt <- ggplot(int_forecasts_df[which(int_forecasts_df$age == 0),]) + theme_bw() +
scale_fill_manual("Model", values = c("Siler" = "purple", "Lee-Carter" = "red",
"Lee-Carter (dt)" = "gold", "Lee-Carter (dxt)" = "green", "Lee-Carter (e0)" = "blue")) +
geom_bar(aes(x = n_ahead-1, y = siler_fe2, fill = "Siler"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead-0.5, y = LC_fe2, fill = "Lee-Carter"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead, y = LC_dt_fe2, fill = "Lee-Carter (dt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead+0.5, y = LC_dxt_fe2, fill = "Lee-Carter (dxt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead+1, y = LC_e0_fe2, fill = "Lee-Carter (e0)"),
stat = "summary", fun = mean, width = 0.5) +
xlab("Years ahead") + ylab("MSE")+ ggtitle("MSE")
err_plt <- ggplot(int_forecasts_df[which(int_forecasts_df$age == 0),]) + theme_bw() +
scale_fill_manual("Model", values = c("Siler" = "purple", "Lee-Carter" = "red",
"Lee-Carter (dt)" = "gold", "Lee-Carter (dxt)" = "green", "Lee-Carter (e0)" = "blue")) +
geom_bar(aes(x = n_ahead-1, y = siler_fe, fill = "Siler"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead-0.5, y = LC_fe, fill = "Lee-Carter"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead, y = LC_dt_fe, fill = "Lee-Carter (dt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead+0.5, y = LC_dxt_fe, fill = "Lee-Carter (dxt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead+1, y = LC_e0_fe, fill = "Lee-Carter (e0)"),
stat = "summary", fun = mean, width = 0.5) +
xlab("Years ahead") + ylab("Mean forecast error")+ ggtitle("FE")
ggarrange(err_plt, fe_plt, nrow = 1, ncol = 2, common.legend = T, legend = "right")
obs <- which(!is.na(int_forecasts_df$siler_fe) & int_forecasts_df$age == 0)
aggregate(int_forecasts_df[obs,c("siler_fe","LC_fe","LC_dt_fe", "LC_dxt_fe", "LC_e0_fe")],
by = list(name = country_forecasts_df$name[obs]), FUN = mean,)
aggregate(int_forecasts_df[obs,c("siler_fe2","LC_fe2","LC_dt_fe2", "LC_dxt_fe2", "LC_e0_fe2")],
by = list(name = country_forecasts_df$name[obs]), FUN = mean,)
obs <- which(!is.na(int_forecasts_df$siler_fe) & int_forecasts_df$age == 0)
aggregate(int_forecasts_df[obs,c("siler_fe","LC_fe","LC_dt_fe", "LC_dxt_fe", "LC_e0_fe")],
by = list(name = country_forecasts_df$name[obs]), FUN = mean,)
aggregate(int_forecasts_df[obs,c("siler_fe2","LC_fe2","LC_dt_fe2", "LC_dxt_fe2", "LC_e0_fe2")],
by = list(name = country_forecasts_df$name[obs]), FUN = mean,)
obs <- which(!is.na(int_forecasts_df$siler_fe) & int_forecasts_df$age == 0 &
int_forecasts_df$est_year > 1970)
aggregate(int_forecasts_df[obs,c("siler_fe","LC_fe","LC_dt_fe", "LC_dxt_fe", "LC_e0_fe")],
by = list(name = country_forecasts_df$name[obs]), FUN = mean,)
int_forecasts_df$est_year
int_forecasts_df$est_year > 1970
obs <- which(!is.na(int_forecasts_df$siler_fe) & int_forecasts_df$age == 0 &
int_forecasts_df$est_year > 1970)
obs
int_forecasts_df$est_year[obs]
aggregate(int_forecasts_df[obs,c("siler_fe","LC_fe","LC_dt_fe", "LC_dxt_fe", "LC_e0_fe")],
by = list(name = country_forecasts_df$name[obs]), FUN = mean,)
aggregate(int_forecasts_df[obs,c("siler_fe","LC_fe","LC_dt_fe", "LC_dxt_fe", "LC_e0_fe")],
by = list(name = int_forecasts_df$name[obs]), FUN = mean,)
obs <- which(!is.na(int_forecasts_df$siler_fe) & int_forecasts_df$age == 0)
aggregate(int_forecasts_df[obs,c("siler_fe","LC_fe","LC_dt_fe", "LC_dxt_fe", "LC_e0_fe")],
by = list(name = int_forecasts_df$name[obs]), FUN = mean,)
obs <- which(!is.na(int_forecasts_df$siler_fe) & int_forecasts_df$age == 0 &
int_forecasts_df$est_year > 1970)
aggregate(int_forecasts_df[obs,c("siler_fe","LC_fe","LC_dt_fe", "LC_dxt_fe", "LC_e0_fe")],
by = list(name = int_forecasts_df$name[obs]), FUN = mean,)
obs <- which(!is.na(int_forecasts_df$siler_fe) & int_forecasts_df$age == 0 &
int_forecasts_df$est_year > 1970)
obs <- which(!is.na(int_forecasts_df$siler_fe) & int_forecasts_df$age == 0 &
int_forecasts_df$est_year > 1970)
fe_plt <- ggplot(int_forecasts_df[obs,]) + theme_bw() +
scale_fill_manual("Model", values = c("Siler" = "purple", "Lee-Carter" = "red",
"Lee-Carter (dt)" = "gold", "Lee-Carter (dxt)" = "green", "Lee-Carter (e0)" = "blue")) +
geom_bar(aes(x = n_ahead-1, y = siler_fe2, fill = "Siler"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead-0.5, y = LC_fe2, fill = "Lee-Carter"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead, y = LC_dt_fe2, fill = "Lee-Carter (dt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead+0.5, y = LC_dxt_fe2, fill = "Lee-Carter (dxt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead+1, y = LC_e0_fe2, fill = "Lee-Carter (e0)"),
stat = "summary", fun = mean, width = 0.5) +
xlab("Years ahead") + ylab("MSE")+ ggtitle("MSE")
err_plt <- ggplot(int_forecasts_df[obs,]) + theme_bw() +
scale_fill_manual("Model", values = c("Siler" = "purple", "Lee-Carter" = "red",
"Lee-Carter (dt)" = "gold", "Lee-Carter (dxt)" = "green", "Lee-Carter (e0)" = "blue")) +
geom_bar(aes(x = n_ahead-1, y = siler_fe, fill = "Siler"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead-0.5, y = LC_fe, fill = "Lee-Carter"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead, y = LC_dt_fe, fill = "Lee-Carter (dt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead+0.5, y = LC_dxt_fe, fill = "Lee-Carter (dxt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead+1, y = LC_e0_fe, fill = "Lee-Carter (e0)"),
stat = "summary", fun = mean, width = 0.5) +
xlab("Years ahead") + ylab("Mean forecast error")+ ggtitle("FE")
ggarrange(err_plt, fe_plt, nrow = 1, ncol = 2, common.legend = T, legend = "right")
obs <- which(!is.na(int_forecasts_df$siler_fe) & int_forecasts_df$age == 0 &
int_forecasts_df$est_year > 1960)
fe_plt <- ggplot(int_forecasts_df[obs,]) + theme_bw() +
scale_fill_manual("Model", values = c("Siler" = "purple", "Lee-Carter" = "red",
"Lee-Carter (dt)" = "gold", "Lee-Carter (dxt)" = "green", "Lee-Carter (e0)" = "blue")) +
geom_bar(aes(x = n_ahead-1, y = siler_fe2, fill = "Siler"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead-0.5, y = LC_fe2, fill = "Lee-Carter"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead, y = LC_dt_fe2, fill = "Lee-Carter (dt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead+0.5, y = LC_dxt_fe2, fill = "Lee-Carter (dxt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead+1, y = LC_e0_fe2, fill = "Lee-Carter (e0)"),
stat = "summary", fun = mean, width = 0.5) +
xlab("Years ahead") + ylab("MSE")+ ggtitle("MSE")
err_plt <- ggplot(int_forecasts_df[obs,]) + theme_bw() +
scale_fill_manual("Model", values = c("Siler" = "purple", "Lee-Carter" = "red",
"Lee-Carter (dt)" = "gold", "Lee-Carter (dxt)" = "green", "Lee-Carter (e0)" = "blue")) +
geom_bar(aes(x = n_ahead-1, y = siler_fe, fill = "Siler"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead-0.5, y = LC_fe, fill = "Lee-Carter"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead, y = LC_dt_fe, fill = "Lee-Carter (dt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead+0.5, y = LC_dxt_fe, fill = "Lee-Carter (dxt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead+1, y = LC_e0_fe, fill = "Lee-Carter (e0)"),
stat = "summary", fun = mean, width = 0.5) +
xlab("Years ahead") + ylab("Mean forecast error")+ ggtitle("FE")
ggarrange(err_plt, fe_plt, nrow = 1, ncol = 2, common.legend = T, legend = "right")
obs <- which(!is.na(int_forecasts_df$siler_fe) & int_forecasts_df$age == 0 &
int_forecasts_df$est_year > 1970)
aggregate(int_forecasts_df[obs,c("siler_fe","LC_fe","LC_dt_fe", "LC_dxt_fe", "LC_e0_fe")],
by = list(name = int_forecasts_df$name[obs]), FUN = mean,)
aggregate(int_forecasts_df[obs,c("siler_fe2","LC_fe2","LC_dt_fe2", "LC_dxt_fe2", "LC_e0_fe2")],
by = list(name = country_forecasts_df$name[obs]), FUN = mean,)
t.test(country_forecasts_df$LC_e0_fe[which(country_forecasts_df$age == 0 &
country_forecasts_df$name == "Netherlands")], na.rm = T)
mean(country_forecasts_df$LC_e0_fe[which(country_forecasts_df$age == 0)]^2, na.rm = T)
t.test(int_forecasts_df$LC_e0_fe[obs], na.rm = T)
mean(int_forecasts_df$LC_e0_fe[obs]^2, na.rm = T)
t.test(int_forecasts_df$siler_fe[obs], na.rm = T)
mean(int_forecasts_df$siler_fe[obs]^2, na.rm = T)
mean(int_forecasts_df$LC_e0_fe[obs]^2, na.rm = T)
t.test(int_forecasts_df$LC_e0_fe[which(country_forecasts_df$age == 0)], na.rm = T)
t.test(int_forecasts_df$LC_e0_err[which(country_forecasts_df$age == 0)], na.rm = T)
mean(int_forecasts_df$LC_e0_err[which(country_forecasts_df$age == 0)]^2, na.rm = T)
t.test(int_forecasts_df$LC_e0_err[obs], na.rm = T)
t.test(int_forecasts_df$LC_e0_err[obs], na.rm = T)
obs
obs <- which(!is.na(int_forecasts_df$siler_fe) & int_forecasts_df$age == 0 &
int_forecasts_df$est_year > 1970)
t.test(int_forecasts_df$siler_fe[obs], na.rm = T)
mean(int_forecasts_df$siler_fe[obs]^2, na.rm = T)
t.test(int_forecasts_df$LC_e0_err[obs], na.rm = T)
t.test(int_forecasts_df$siler_err[obs], na.rm = T)
country_siler_df <- data.frame(matrix(NA, nrow = 0, ncol = 7))
names(country_siler_df) <-c("name","year", "est_year", "age", "mx_siler", "lx_siler", "ex_siler")
cc <- countries[1]
yy <- est_years[1]
for (cc in countries){
country_df <- mort_df[which(mort_df$name == cc & mort_df$year >= 1900),]
code <- unique(country_df$code)
if (paste0(code,"_LEgrad_oos.csv") %in% dir("figures/countries/held-out/")){
print(paste0("Siler forecasts for ", cc))
sil_forecasts_df <- read.csv(paste0("figures/countries/held-out/", code,"_LEgrad_oos.csv"), stringsAsFactors = F)
sil_forecasts_df$Forecast <- "Estimate"
sil_forecasts_df$Forecast[which(sil_forecasts_df$forecast == 1)] <- "Forecast"
sil_forecasts_df$`Estimation Year` <- as.character(sil_forecasts_df$est_year)
sil_forecasts_df <- merge(sil_forecasts_df, bp_df[,c("year", "age", "Female")],
by = c("year", "age"), all.x = T)
# Create a lifetable from the siler mortality estimates.
est_years <- sort(unique(sil_forecasts_df$est_year))
siler_df <- data.frame(matrix(NA, nrow = 0, ncol = 6))
names(siler_df) <-c("year", "est_year", "age", "mx_siler", "lx_siler", "ex_siler")
yy <- est_years[6]
for (yy in est_years){
mx_matrix <- cast(sil_forecasts_df[which(sil_forecasts_df$est_year == yy),c("year", "age", "mortality")],
age ~ year, value = "mortality")
pop_matrix <- cast(sil_forecasts_df[which(sil_forecasts_df$est_year == yy),c("year", "age", "Female")],
age ~ year, value = "Female")
siler_demdata <- demogdata(data=mx_matrix[,2:ncol(mx_matrix)],
pop = pop_matrix[2:ncol(mx_matrix)],
ages=mx_matrix$age,
years = as.numeric(names(mx_matrix[,2:ncol(mx_matrix)])),
type= "mortality",label="Siler", name="female")
siler_lt <- lifetable(siler_demdata, ages = siler_demdata$age)
# Extract the life expectancy
siler_ex <- data.frame(siler_lt$ex)
siler_ex$age <- rownames(siler_ex)
siler_ex <- reshape2::melt(siler_ex, id = "age", variable.name = "year",value.name = "ex_siler")
siler_ex$year <- as.numeric(str_remove(siler_ex$year, "X"))
siler_lx <- data.frame(siler_lt$lx)
siler_lx$age <- rownames(siler_lx)
siler_lx <- reshape2::melt(siler_lx, id = "age", variable.name = "year",value.name = "lx_siler")
siler_lx$year <- as.numeric(str_remove(siler_lx$year, "X"))
siler_mx <- data.frame(siler_lt$mx)
siler_mx$age <- rownames(siler_mx)
siler_mx <- reshape2::melt(siler_mx, id = "age", variable.name = "year",value.name = "mx_siler")
siler_mx$year <- as.numeric(str_remove(siler_mx$year, "X"))
# Add the recalculated life expectancy to the bottom of the df
siler_ex$est_year <- yy
temp_df <- merge(siler_ex, siler_mx, by = c("year", "age"))
temp_df <- merge(temp_df, siler_lx, by = c("year", "age"))
siler_df <- rbind(siler_df, temp_df[names(siler_df)])
}
siler_df$name <- cc
country_siler_df <- rbind(country_siler_df, siler_df[,names(country_siler_df)])
}
}
rm(siler_df, temp_df, siler_ex, siler_lx, siler_mx, siler_demdata, sil_forecasts_df,
siler_lt, mx_matrix, pop_matrix)
int_forecasts_df <- merge(country_forecasts_df, country_siler_df,
by = c("name", "year", "age", "est_year"), all.x = T)
ggplot(int_forecasts_df[which(int_forecasts_df$age == 0 & !is.na(int_forecasts_df$ex_siler)),]) + theme_bw() +
facet_wrap(name~., nrow = 4, scales = "free") +
geom_point(aes(x = year, y = ex_f), shape = 3) +
scale_color_manual("Model", values = c("Siler" = "purple", "Lee-Carter" = "red",
"Lee-Carter (dt)" = "gold", "Lee-Carter (dxt)" = "green", "Lee-Carter (e0)" = "blue")) +
geom_line(aes(x = year, y = ex_siler, group = est_year, color = "Siler"), alpha =0.3) +
geom_line(aes(x = year, y = ex_LC_e0, group = est_year, color = "Lee-Carter (e0)"), alpha =0.3) +
#geom_line(aes(x = year, y = ex_siler, group = est_year, color = "Siler")) +
xlab("Year") + ylab("Life expectancy at birth")
int_forecasts_df$n_ahead <- int_forecasts_df$year - int_forecasts_df$est_year
int_forecasts_df$n_ahead[which(int_forecasts_df$n_ahead <= 0)] <- NA
int_forecasts_df <- compute_fe(int_forecasts_df, suffix = "siler")
int_forecasts_df <- compute_fe(int_forecasts_df, suffix = "LC")
int_forecasts_df <- compute_fe(int_forecasts_df, suffix = "LC_dt")
int_forecasts_df <- compute_fe(int_forecasts_df, suffix = "LC_dxt")
int_forecasts_df <- compute_fe(int_forecasts_df, suffix = "LC_e0")
obs <- which(!is.na(int_forecasts_df$siler_fe) & int_forecasts_df$age == 0 &
int_forecasts_df$est_year > 1960)
fe_plt <- ggplot(int_forecasts_df[obs,]) + theme_bw() +
scale_fill_manual("Model", values = c("Siler" = "purple", "Lee-Carter" = "red",
"Lee-Carter (dt)" = "gold", "Lee-Carter (dxt)" = "green", "Lee-Carter (e0)" = "blue")) +
geom_bar(aes(x = n_ahead-1, y = siler_fe2, fill = "Siler"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead-0.5, y = LC_fe2, fill = "Lee-Carter"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead, y = LC_dt_fe2, fill = "Lee-Carter (dt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead+0.5, y = LC_dxt_fe2, fill = "Lee-Carter (dxt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead+1, y = LC_e0_fe2, fill = "Lee-Carter (e0)"),
stat = "summary", fun = mean, width = 0.5) +
xlab("Years ahead") + ylab("MSE")+ ggtitle("MSE")
err_plt <- ggplot(int_forecasts_df[obs,]) + theme_bw() +
scale_fill_manual("Model", values = c("Siler" = "purple", "Lee-Carter" = "red",
"Lee-Carter (dt)" = "gold", "Lee-Carter (dxt)" = "green", "Lee-Carter (e0)" = "blue")) +
geom_bar(aes(x = n_ahead-1, y = siler_fe, fill = "Siler"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead-0.5, y = LC_fe, fill = "Lee-Carter"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead, y = LC_dt_fe, fill = "Lee-Carter (dt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead+0.5, y = LC_dxt_fe, fill = "Lee-Carter (dxt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead+1, y = LC_e0_fe, fill = "Lee-Carter (e0)"),
stat = "summary", fun = mean, width = 0.5) +
xlab("Years ahead") + ylab("Mean forecast error")+ ggtitle("FE")
ggarrange(err_plt, fe_plt, nrow = 1, ncol = 2, common.legend = T, legend = "right")
obs <- which(!is.na(int_forecasts_df$siler_fe) & int_forecasts_df$age == 0 &
int_forecasts_df$est_year > 1980)
fe_plt <- ggplot(int_forecasts_df[obs,]) + theme_bw() +
scale_fill_manual("Model", values = c("Siler" = "purple", "Lee-Carter" = "red",
"Lee-Carter (dt)" = "gold", "Lee-Carter (dxt)" = "green", "Lee-Carter (e0)" = "blue")) +
geom_bar(aes(x = n_ahead-1, y = siler_fe2, fill = "Siler"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead-0.5, y = LC_fe2, fill = "Lee-Carter"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead, y = LC_dt_fe2, fill = "Lee-Carter (dt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead+0.5, y = LC_dxt_fe2, fill = "Lee-Carter (dxt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead+1, y = LC_e0_fe2, fill = "Lee-Carter (e0)"),
stat = "summary", fun = mean, width = 0.5) +
xlab("Years ahead") + ylab("MSE")+ ggtitle("MSE")
err_plt <- ggplot(int_forecasts_df[obs,]) + theme_bw() +
scale_fill_manual("Model", values = c("Siler" = "purple", "Lee-Carter" = "red",
"Lee-Carter (dt)" = "gold", "Lee-Carter (dxt)" = "green", "Lee-Carter (e0)" = "blue")) +
geom_bar(aes(x = n_ahead-1, y = siler_fe, fill = "Siler"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead-0.5, y = LC_fe, fill = "Lee-Carter"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead, y = LC_dt_fe, fill = "Lee-Carter (dt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead+0.5, y = LC_dxt_fe, fill = "Lee-Carter (dxt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead+1, y = LC_e0_fe, fill = "Lee-Carter (e0)"),
stat = "summary", fun = mean, width = 0.5) +
xlab("Years ahead") + ylab("Mean forecast error")+ ggtitle("FE")
ggarrange(err_plt, fe_plt, nrow = 1, ncol = 2, common.legend = T, legend = "right")
obs <- which(!is.na(int_forecasts_df$siler_fe) & int_forecasts_df$age == 0 &
int_forecasts_df$est_year > 1980)
aggregate(int_forecasts_df[obs,c("siler_fe","LC_fe","LC_dt_fe", "LC_dxt_fe", "LC_e0_fe")],
by = list(name = int_forecasts_df$name[obs]), FUN = mean,)
aggregate(int_forecasts_df[obs,c("siler_fe2","LC_fe2","LC_dt_fe2", "LC_dxt_fe2", "LC_e0_fe2")],
by = list(name = country_forecasts_df$name[obs]), FUN = mean,)
t.test(int_forecasts_df$LC_e0_fe[obs], na.rm = T)
mean(int_forecasts_df$LC_e0_fe[obs]^2, na.rm = T)
t.test(int_forecasts_df$siler_fe[obs], na.rm = T)
mean(int_forecasts_df$siler_fe[obs]^2, na.rm = T)
obs <- which(!is.na(int_forecasts_df$siler_fe) & int_forecasts_df$age == 0 &
int_forecasts_df$est_year > 1960)
aggregate(int_forecasts_df[obs,c("siler_fe","LC_fe","LC_dt_fe", "LC_dxt_fe", "LC_e0_fe")],
by = list(name = int_forecasts_df$name[obs]), FUN = mean,)
aggregate(int_forecasts_df[obs,c("siler_fe2","LC_fe2","LC_dt_fe2", "LC_dxt_fe2", "LC_e0_fe2")],
by = list(name = country_forecasts_df$name[obs]), FUN = mean,)
ggplot(int_forecasts_df[which(int_forecasts_df$age == 0 & !is.na(int_forecasts_df$ex_siler)),]) + theme_bw() +
facet_wrap(name~., nrow = 4, scales = "free") +
geom_point(aes(x = year, y = ex_f), shape = 3) +
scale_color_manual("Model", values = c("Siler" = "purple", "Lee-Carter" = "red",
"Lee-Carter (dt)" = "gold", "Lee-Carter (dxt)" = "green", "Lee-Carter (e0)" = "blue")) +
geom_line(aes(x = year, y = ex_siler, group = est_year, color = "Siler"), alpha =0.3) +
geom_line(aes(x = year, y = ex_LC_e0, group = est_year, color = "Lee-Carter (e0)"), alpha =0.3) +
xlab("Year") + ylab("Life expectancy at birth")
int_forecasts_df$n_ahead <- int_forecasts_df$year - int_forecasts_df$est_year
int_forecasts_df$n_ahead[which(int_forecasts_df$n_ahead <= 0)] <- NA
int_forecasts_df <- compute_fe(int_forecasts_df, suffix = "siler")
int_forecasts_df <- compute_fe(int_forecasts_df, suffix = "LC")
int_forecasts_df <- compute_fe(int_forecasts_df, suffix = "LC_dt")
int_forecasts_df <- compute_fe(int_forecasts_df, suffix = "LC_dxt")
int_forecasts_df <- compute_fe(int_forecasts_df, suffix = "LC_e0")
# Plot the errors
obs <- which(!is.na(int_forecasts_df$siler_fe) & int_forecasts_df$age == 0 &
int_forecasts_df$est_year > 1960)
fe_plt <- ggplot(int_forecasts_df[obs,]) + theme_bw() +
scale_fill_manual("Model", values = c("Siler" = "purple", "Lee-Carter" = "red",
"Lee-Carter (dt)" = "gold", "Lee-Carter (dxt)" = "green", "Lee-Carter (e0)" = "blue")) +
geom_bar(aes(x = n_ahead-1, y = siler_fe2, fill = "Siler"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead-0.5, y = LC_fe2, fill = "Lee-Carter"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead, y = LC_dt_fe2, fill = "Lee-Carter (dt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead+0.5, y = LC_dxt_fe2, fill = "Lee-Carter (dxt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead+1, y = LC_e0_fe2, fill = "Lee-Carter (e0)"),
stat = "summary", fun = mean, width = 0.5) +
xlab("Years ahead") + ylab("MSE")+ ggtitle("MSE")
err_plt <- ggplot(int_forecasts_df[obs,]) + theme_bw() +
scale_fill_manual("Model", values = c("Siler" = "purple", "Lee-Carter" = "red",
"Lee-Carter (dt)" = "gold", "Lee-Carter (dxt)" = "green", "Lee-Carter (e0)" = "blue")) +
geom_bar(aes(x = n_ahead-1, y = siler_fe, fill = "Siler"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead-0.5, y = LC_fe, fill = "Lee-Carter"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead, y = LC_dt_fe, fill = "Lee-Carter (dt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead+0.5, y = LC_dxt_fe, fill = "Lee-Carter (dxt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead+1, y = LC_e0_fe, fill = "Lee-Carter (e0)"),
stat = "summary", fun = mean, width = 0.5) +
xlab("Years ahead") + ylab("Mean forecast error")+ ggtitle("FE")
ggarrange(err_plt, fe_plt, nrow = 1, ncol = 2, common.legend = T, legend = "right")
obs <- which(!is.na(int_forecasts_df$siler_fe) & int_forecasts_df$age == 0 &
int_forecasts_df$est_year > 1960)
aggregate(int_forecasts_df[obs,c("siler_fe","LC_fe","LC_dt_fe", "LC_dxt_fe", "LC_e0_fe")],
by = list(name = int_forecasts_df$name[obs]), FUN = mean,)
aggregate(int_forecasts_df[obs,c("siler_fe2","LC_fe2","LC_dt_fe2", "LC_dxt_fe2", "LC_e0_fe2")],
by = list(name = country_forecasts_df$name[obs]), FUN = mean,)
t.test(int_forecasts_df$LC_e0_fe[obs], na.rm = T)
mean(int_forecasts_df$LC_e0_fe[obs]^2, na.rm = T)
t.test(int_forecasts_df$siler_fe[obs], na.rm = T)
mean(int_forecasts_df$siler_fe[obs]^2, na.rm = T)
mean(int_forecasts_df$siler_fe[obs]^2, na.rm = T)
mean(int_forecasts_df$LC_e0_fe[obs]^2, na.rm = T)
mean(int_forecasts_df$LC_fe[obs]^2, na.rm = T)
mean(int_forecasts_df$LC_dt_fe[obs]^2, na.rm = T)
mean(int_forecasts_df$LC_dxt_fe[obs]^2, na.rm = T)
obs <- which(!is.na(int_forecasts_df$siler_fe) & int_forecasts_df$age == 0 &
int_forecasts_df$est_year > 1980)
mean(int_forecasts_df$LC_e0_fe[obs]^2, na.rm = T)
mean(int_forecasts_df$siler_fe[obs]^2, na.rm = T)
mean(int_forecasts_df$LC_fe[obs]^2, na.rm = T)
mean(int_forecasts_df$LC_dt_fe[obs]^2, na.rm = T)
mean(int_forecasts_df$LC_dxt_fe[obs]^2, na.rm = T)
mean(int_forecasts_df$siler_fe[obs]^2, na.rm = T)
t.test(int_forecasts_df$siler_fe[obs], na.rm = T)
t.test(int_forecasts_df$LC_e0_fe[obs], na.rm = T)
mean(int_forecasts_df$siler_fe[obs]^2, na.rm = T)
obs <- which(!is.na(int_forecasts_df$siler_fe) & int_forecasts_df$age == 0 &
int_forecasts_df$est_year > 1970)
t.test(int_forecasts_df$siler_fe[obs], na.rm = T)
obs <- which(!is.na(int_forecasts_df$siler_fe) & int_forecasts_df$age == 0 &
int_forecasts_df$est_year > 1990)
mean(int_forecasts_df$siler_fe[obs]^2, na.rm = T)
t.test(int_forecasts_df$siler_fe[obs], na.rm = T)
obs <- which(!is.na(int_forecasts_df$siler_fe) & int_forecasts_df$age == 0 &
int_forecasts_df$est_year > 1960)
t.test(int_forecasts_df$LC_e0_fe[obs], na.rm = T)
mean(int_forecasts_df$LC_e0_fe[obs]^2, na.rm = T)
t.test(int_forecasts_df$siler_fe[obs], na.rm = T)
mean(int_forecasts_df$siler_fe[obs]^2, na.rm = T)
t.test(int_forecasts_df$LC_e0_fe[obs], na.rm = T)
mean(int_forecasts_df$LC_e0_fe[obs]^2, na.rm = T)
t.test(int_forecasts_df$siler_fe[obs], na.rm = T)
mean(int_forecasts_df$siler_fe[obs]^2, na.rm = T)
obs <- which(!is.na(int_forecasts_df$siler_fe) & int_forecasts_df$age == 0 &
int_forecasts_df$est_year > 1960)
aggregate(int_forecasts_df[obs,c("siler_fe","LC_fe","LC_dt_fe", "LC_dxt_fe", "LC_e0_fe")],
by = list(name = int_forecasts_df$name[obs]), FUN = mean,)
aggregate(int_forecasts_df[obs,c("siler_fe2","LC_fe2","LC_dt_fe2", "LC_dxt_fe2", "LC_e0_fe2")],
by = list(name = country_forecasts_df$name[obs]), FUN = mean,)
country_siler_df <- data.frame(matrix(NA, nrow = 0, ncol = 7))
names(country_siler_df) <-c("name","year", "est_year", "age", "mx_siler", "lx_siler", "ex_siler")
cc <- countries[1]
yy <- est_years[1]
for (cc in countries){
country_df <- mort_df[which(mort_df$name == cc & mort_df$year >= 1900),]
code <- unique(country_df$code)
if (paste0(code,"_LEgrad_oos.csv") %in% dir("figures/countries/held-out/")){
print(paste0("Siler forecasts for ", cc))
sil_forecasts_df <- read.csv(paste0("figures/countries/held-out/", code,"_LEgrad_oos.csv"), stringsAsFactors = F)
sil_forecasts_df$Forecast <- "Estimate"
sil_forecasts_df$Forecast[which(sil_forecasts_df$forecast == 1)] <- "Forecast"
sil_forecasts_df$`Estimation Year` <- as.character(sil_forecasts_df$est_year)
sil_forecasts_df <- merge(sil_forecasts_df, bp_df[,c("year", "age", "Female")],
by = c("year", "age"), all.x = T)
# Create a lifetable from the siler mortality estimates.
est_years <- sort(unique(sil_forecasts_df$est_year))
siler_df <- data.frame(matrix(NA, nrow = 0, ncol = 6))
names(siler_df) <-c("year", "est_year", "age", "mx_siler", "lx_siler", "ex_siler")
yy <- est_years[6]
for (yy in est_years){
mx_matrix <- cast(sil_forecasts_df[which(sil_forecasts_df$est_year == yy),c("year", "age", "mortality")],
age ~ year, value = "mortality")
pop_matrix <- cast(sil_forecasts_df[which(sil_forecasts_df$est_year == yy),c("year", "age", "Female")],
age ~ year, value = "Female")
siler_demdata <- demogdata(data=mx_matrix[,2:ncol(mx_matrix)],
pop = pop_matrix[2:ncol(mx_matrix)],
ages=mx_matrix$age,
years = as.numeric(names(mx_matrix[,2:ncol(mx_matrix)])),
type= "mortality",label="Siler", name="female")
siler_lt <- lifetable(siler_demdata, ages = siler_demdata$age)
# Extract the life expectancy
siler_ex <- data.frame(siler_lt$ex)
siler_ex$age <- rownames(siler_ex)
siler_ex <- reshape2::melt(siler_ex, id = "age", variable.name = "year",value.name = "ex_siler")
siler_ex$year <- as.numeric(str_remove(siler_ex$year, "X"))
siler_lx <- data.frame(siler_lt$lx)
siler_lx$age <- rownames(siler_lx)
siler_lx <- reshape2::melt(siler_lx, id = "age", variable.name = "year",value.name = "lx_siler")
siler_lx$year <- as.numeric(str_remove(siler_lx$year, "X"))
siler_mx <- data.frame(siler_lt$mx)
siler_mx$age <- rownames(siler_mx)
siler_mx <- reshape2::melt(siler_mx, id = "age", variable.name = "year",value.name = "mx_siler")
siler_mx$year <- as.numeric(str_remove(siler_mx$year, "X"))
# Add the recalculated life expectancy to the bottom of the df
siler_ex$est_year <- yy
temp_df <- merge(siler_ex, siler_mx, by = c("year", "age"))
temp_df <- merge(temp_df, siler_lx, by = c("year", "age"))
siler_df <- rbind(siler_df, temp_df[names(siler_df)])
}
siler_df$name <- cc
country_siler_df <- rbind(country_siler_df, siler_df[,names(country_siler_df)])
}
}
rm(siler_df, temp_df, siler_ex, siler_lx, siler_mx, siler_demdata, sil_forecasts_df,
siler_lt, mx_matrix, pop_matrix)
int_forecasts_df <- merge(country_forecasts_df, country_siler_df,
by = c("name", "year", "age", "est_year"), all.x = T)
ggplot(int_forecasts_df[which(int_forecasts_df$age == 0 & !is.na(int_forecasts_df$ex_siler)),]) + theme_bw() +
facet_wrap(name~., nrow = 4, scales = "free") +
geom_point(aes(x = year, y = ex_f), shape = 3) +
scale_color_manual("Model", values = c("Siler" = "purple", "Lee-Carter" = "red",
"Lee-Carter (dt)" = "gold", "Lee-Carter (dxt)" = "green", "Lee-Carter (e0)" = "blue")) +
geom_line(aes(x = year, y = ex_siler, group = est_year, color = "Siler"), alpha =0.3) +
geom_line(aes(x = year, y = ex_LC_e0, group = est_year, color = "Lee-Carter (e0)"), alpha =0.3) +
xlab("Year") + ylab("Life expectancy at birth")
int_forecasts_df$n_ahead <- int_forecasts_df$year - int_forecasts_df$est_year
int_forecasts_df$n_ahead[which(int_forecasts_df$n_ahead <= 0)] <- NA
int_forecasts_df <- compute_fe(int_forecasts_df, suffix = "siler")
int_forecasts_df <- compute_fe(int_forecasts_df, suffix = "LC")
int_forecasts_df <- compute_fe(int_forecasts_df, suffix = "LC_dt")
int_forecasts_df <- compute_fe(int_forecasts_df, suffix = "LC_dxt")
int_forecasts_df <- compute_fe(int_forecasts_df, suffix = "LC_e0")
obs <- which(!is.na(int_forecasts_df$siler_fe) & int_forecasts_df$age == 0 &
int_forecasts_df$est_year > 1960)
fe_plt <- ggplot(int_forecasts_df[obs,]) + theme_bw() +
scale_fill_manual("Model", values = c("Siler" = "purple", "Lee-Carter" = "red",
"Lee-Carter (dt)" = "gold", "Lee-Carter (dxt)" = "green", "Lee-Carter (e0)" = "blue")) +
geom_bar(aes(x = n_ahead-1, y = siler_fe2, fill = "Siler"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead-0.5, y = LC_fe2, fill = "Lee-Carter"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead, y = LC_dt_fe2, fill = "Lee-Carter (dt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead+0.5, y = LC_dxt_fe2, fill = "Lee-Carter (dxt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead+1, y = LC_e0_fe2, fill = "Lee-Carter (e0)"),
stat = "summary", fun = mean, width = 0.5) +
xlab("Years ahead") + ylab("MSE")+ ggtitle("MSE")
err_plt <- ggplot(int_forecasts_df[obs,]) + theme_bw() +
scale_fill_manual("Model", values = c("Siler" = "purple", "Lee-Carter" = "red",
"Lee-Carter (dt)" = "gold", "Lee-Carter (dxt)" = "green", "Lee-Carter (e0)" = "blue")) +
geom_bar(aes(x = n_ahead-1, y = siler_fe, fill = "Siler"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead-0.5, y = LC_fe, fill = "Lee-Carter"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead, y = LC_dt_fe, fill = "Lee-Carter (dt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead+0.5, y = LC_dxt_fe, fill = "Lee-Carter (dxt)"),
stat = "summary", fun = mean, width = 0.5) +
geom_bar(aes(x = n_ahead+1, y = LC_e0_fe, fill = "Lee-Carter (e0)"),
stat = "summary", fun = mean, width = 0.5) +
xlab("Years ahead") + ylab("Mean forecast error")+ ggtitle("FE")
ggarrange(err_plt, fe_plt, nrow = 1, ncol = 2, common.legend = T, legend = "right")
obs <- which(!is.na(int_forecasts_df$siler_fe) & int_forecasts_df$age == 0 &
int_forecasts_df$est_year > 1960)
aggregate(int_forecasts_df[obs,c("siler_fe","LC_fe","LC_dt_fe", "LC_dxt_fe", "LC_e0_fe")],
by = list(name = int_forecasts_df$name[obs]), FUN = mean,)
require(googleCloudStorageR)
install.packages("googleCloudStorageR")
